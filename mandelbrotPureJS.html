<html>
    <head>
        <title>Mandelbrot</title>
        <meta http-equiv=Content-Type content='text/html; charset=utf-8'>
        <meta HTTP-EQUIV='Pragma' CONTENT='no-cache'>
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script>

            //-------------------------------------------------------------------------------------
            
            var offset_x = -0.1089;
            var offset_y = -0.89598;
            var scale = 128;
            var limit = 5000;

            var half_h;
            var half_w;
            var full_h;
            var full_w;
            var one_over_min_half;
            var context;

            // We iterate from one palette to the next in small steps
            var old_palette;
            var new_palette;
            var palette_counter = 0;
            var palette_size = 500;

            var escape_array;

            var interval_token = -1;
        
            //-------------------------------------------------------------------------------------
            
            function ViewToComplex(x, y) {
                            
                var multipler

                // Map (0->w) to (-1, 1);
                var x_complex = offset_x + ((x - half_w) * one_over_min_half);
                var y_complex = offset_y + ((y - half_h) * one_over_min_half);

                return([x_complex, y_complex]);
            }

            //-------------------------------------------------------------------------------------

            function ComplexToMandelbrot(c_real, c_imag) {

                var real = 0;
                var imag = 0;

                var new_real;
                var new_imag;

                var new_real_square = 0;
                var new_imag_square = 0;

                for (i = 1; i < limit; i++) {

                    new_real = c_real + new_real_square - new_imag_square;
                    new_imag = c_imag + (2 * real * imag);

                    new_real_square = Math.pow(new_real, 2);
                    new_imag_square = Math.pow(new_imag, 2);

                    if (new_real_square + new_imag_square > 4) {
                        return i;
                    }
                    real = new_real;
                    imag = new_imag;
                }

                return 0;
            }

            //-------------------------------------------------------------------------------------
            
            function MandelbrotToColour(mand) {
                return palette[mand];
            }

            //-------------------------------------------------------------------------------------
            
            function GenerateEscapeValues(){

                var origin_complex = ViewToComplex(0, 0);
                var x_complex = ViewToComplex(1, 0);
                var y_complex = ViewToComplex(0, 1);

                var step_x_real = x_complex[0] - origin_complex[0];
                var step_x_imag = x_complex[1] - origin_complex[1];
                var step_y_real = y_complex[0] - origin_complex[0];
                var step_y_imag = y_complex[1] - origin_complex[1];

                var complex_x_iter_real;
                var complex_x_iter_image;
                var complex_y_iter_real = origin_complex[0];
                var complex_y_iter_imag = origin_complex[1];

                var i, j;
                
                var j_step;
                for (j = 0; j < full_h; j++) {
                    
                    
                    complex_x_iter_real = complex_y_iter_real;
                    complex_x_iter_imag = complex_y_iter_imag;
                    
                    j_step = j*full_w;
                    for (i = 0; i < full_w; i++) {
                    
                        var mand = ComplexToMandelbrot(complex_x_iter_real, complex_x_iter_imag);
                        if (mand === 0) {
                            palette_index = 0;
                        } else {
                            palette_index = Math.round((mand / limit) * palette_size);
                            palette_index = Math.max(Math.min(palette_size - 1, palette_index), 1);
                        }
                        escape_array[i + j_step] = palette_index;
                       
                        complex_x_iter_real += step_x_real;
                        complex_x_iter_imag += step_x_imag;
                    }
                    complex_y_iter_real += step_y_real;
                    complex_y_iter_imag += step_y_imag;
                }
                return escape_array;
            }

            //-------------------------------------------------------------------------------------

            function BrightColour() {
                return Math.floor(Math.random() * 100 + 155);
            }

            //-------------------------------------------------------------------------------------

            function DimColour() {
                return Math.floor(Math.random() * 155);
            }

            //-------------------------------------------------------------------------------------

            function CreatePalette() {
                // Set up the palette:
                var palette = new Array(palette_size);
                palette[0] = [0, 0, 0];
              
                // Choose a colour (red, green, blue, cyan, magenta, yellow);
                var bright_index = Math.floor(Math.random() * 6);
            
                var r_func;
                if (bright_index == 0 || bright_index == 3 || bright_index == 4) {
                    r_func = BrightColour;
                } else {
                    r_func = DimColour;
                }

                var g_func;
                if (bright_index == 1 || bright_index == 3 || bright_index == 5) {
                    g_func = BrightColour;
                } else {
                    g_func = DimColour;
                }

                var b_func;
                if (bright_index == 2 || bright_index == 4 || bright_index == 5) {
                    b_func = BrightColour;
                } else {
                    b_func = DimColour;
                }

                for (i = 1; i < palette_size; i++) {
                    palette[i] = [r_func(), g_func(), b_func()];
                }

                return palette;
            }

            //-------------------------------------------------------------------------------------
            
            function GetCurrentPalette() {

                var old_frac = 1 - (palette_counter / 100);
                var new_frac = palette_counter / 100;

                var size = old_palette.length;
                var current_palette = new Array(size);

                current_palette[0] = [0, 0, 0];

                for (i = 1; i < size; i++) {

                    current_palette[i] = [
                        old_palette[i][0] * old_frac + new_palette[i][0] * new_frac,
                        old_palette[i][1] * old_frac + new_palette[i][1] * new_frac,
                        old_palette[i][2] * old_frac + new_palette[i][2] * new_frac
                    ];
                }

                palette_counter++;

                if (palette_counter >= 100) {
                    palette_counter = 0;
                    old_palette = new_palette;
                    new_palette = CreatePalette();
                }

                return current_palette;
            }

            //-------------------------------------------------------------------------------------
            
            function DrawCanvas(){
                         
                var canvasData = context.getImageData(0, 0, full_w, full_h);
                
                var colour;
                var canvas_index;

                var palette = GetCurrentPalette();

                for (i = 0; i < escape_array.length; i++) {

                    colour = palette[escape_array[i]];
                    
                    canvas_index = 4*i;
                    
                    canvasData.data[canvas_index + 0] = colour[0];
                    canvasData.data[canvas_index + 1] = colour[1];
                    canvasData.data[canvas_index + 2] = colour[2];
                    canvasData.data[canvas_index + 3] = 255;
                }
                
                context.putImageData(canvasData, 0, 0);
            }
            
            //-------------------------------------------------------------------------------------
            
            function zoom_handler(event) {

                StopColourLoop();

                var delta = 0;

                if (!event) event = window.event;
                // normalize the delta
                if (event.wheelDelta) {
                    // IE and Opera
                    delta = event.wheelDelta / 60;
                } else if (event.detail) {
                    // W3C
                    delta = -event.detail / 2;
                }
                if (delta > 0) {
                    scale *= delta;
                } else {
                    scale /= -delta;
                }

                one_over_min_half = 1 / (scale * Math.min(half_w, half_h));
                GenerateEscapeValues();
                DrawCanvas();

                StartColourLoop();
            }
            
            //-------------------------------------------------------------------------------------
            
            function click_handler(event) {

                StopColourLoop();

                var complex = ViewToComplex(event.pageX, event.pageY);
                offset_x = complex[0];
                offset_y = complex[1];

                scale *= 1.5;
                one_over_min_half = 1 / (scale * Math.min(half_w, half_h));

                GenerateEscapeValues();
                DrawCanvas();

                StartColourLoop();
            }

            //-------------------------------------------------------------------------------------

            function StopColourLoop() {

                if (interval_token != -1) {
                    clearInterval(interval_token);
                    interval_token = -1;
                }
            }

            //-------------------------------------------------------------------------------------

            function StartColourLoop() {

                // Start the tick function to change the colours
                StopColourLoop();

                interval_token = setInterval(function () { DrawCanvas(); }, 50);
            }

            //-------------------------------------------------------------------------------------

            $(window).resize(function () {
                SetUp();
            });
            
            //-------------------------------------------------------------------------------------

            $(document).ready(function () {

                var canvas = $("#MandelbrotCanvas")[0];
                canvas.addEventListener('click', click_handler, false);

                if (window.addEventListener) {
                    document.addEventListener('DOMMouseScroll', zoom_handler, false);
                }
                document.onmousewheel = zoom_handler;

                SetUp();
            });

            //-------------------------------------------------------------------------------------

            function SetUp() {

                StopColourLoop();

                // Set up some initial variables
                var canvas = $("#MandelbrotCanvas")[0];
                canvas.width = window.innerWidth - 20;
                canvas.height = window.innerHeight - 20;
                full_w = canvas.width;
                full_h = canvas.height;

                // Create the array of escape values
                escape_array = new Array(full_w * full_h);

                // Grab the context
                context = canvas.getContext("2d");

                half_w = full_w * 0.5;
                half_h = full_h * 0.5;
                one_over_min_half = 1 / (scale * Math.min(half_w, half_h));

                old_palette = CreatePalette();
                new_palette = CreatePalette();
                palette_counter = 0;

                GenerateEscapeValues();
                DrawCanvas();
                StartColourLoop();
            }

            //-------------------------------------------------------------------------------------

        </script>

    </head>
    <body>
        <canvas id="MandelbrotCanvas"> 
        </canvas>
    </body>
</html>