<html>
<meta name="apple-mobile-web-app-capable" content="yes">
<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/web/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/web/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/web/favicon/favicon-16x16.png">
    <title>Mandelbrot</title>
    <meta http-equiv=Content-Type content='text/html; charset=utf-8'>
    <meta HTTP-EQUIV='Pragma' CONTENT='no-cache'>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://hammerjs.github.io/dist/hammer.js"></script>
    <script src="web/mandelbrot.js"></script>
    <script src="web/mandelbrotMouse.js"></script>
    <script>

        var limit = 10000;

        function SetOneOverMinHalf() {
            one_over_min_half = 1 / (scale * Math.min(half_w, half_h));
        }

        function NewMandelbrot() {
            StopColourLoop();
            GenerateEscapeValues();
            DrawCanvas();
            StartColourLoop();
        }

        function GenerateEscapeValues() {

            var origin_complex = ViewToComplex(0, 0);
            var x_complex = ViewToComplex(1, 0);
            var y_complex = ViewToComplex(0, 1);

            var step_x_real = x_complex[0] - origin_complex[0];
            var step_x_imag = x_complex[1] - origin_complex[1];
            var step_y_real = y_complex[0] - origin_complex[0];
            var step_y_imag = y_complex[1] - origin_complex[1];

            var complex_x_iter_real;
            var complex_y_iter_real = origin_complex[0];
            var complex_y_iter_imag = origin_complex[1];

            var i, j;

            var j_step;
            for (j = 0; j < full_h; j++) {

                complex_x_iter_real = complex_y_iter_real;
                complex_x_iter_imag = complex_y_iter_imag;

                j_step = j * full_w;
                for (i = 0; i < full_w; i++) {

                    escape_array[i + j_step] = ComplexToMandelbrot(complex_x_iter_real, complex_x_iter_imag);;

                    complex_x_iter_real += step_x_real;
                    complex_x_iter_imag += step_x_imag;
                }
                complex_y_iter_real += step_y_real;
                complex_y_iter_imag += step_y_imag;
            }
        }
        function ComplexToMandelbrot(c_real, c_imag) {

            var z_real = 0.0;
            var z_imag = 0.0;
            var w = 0.0;

            var derivr = 1;
            var derivi = 0;

            for (var l = 1; l < limit; l++) {

                var r = z_real - z_imag + c_real;
                var i = w - z_real - z_imag + c_imag;

                if (derivr * derivr + derivi * derivi < 1e-9) {
                    return 0;
                }

                var new_derivr = 2 * (derivr * r - derivi * i);
                derivi = 2 * (derivr * i + derivi * r);
                derivr = new_derivr;

                z_real = r * r;
                z_imag = i * i;

                var rplusi = (r + i);
                w = rplusi * rplusi;

                var mag = z_real + z_imag;

                if (mag > 4) {
                    return l;
                }
            }
            return 0;
        }


    </script>

</head>
<body>
    <canvas id="MandelbrotCanvas"></canvas>
</body>
</html>
